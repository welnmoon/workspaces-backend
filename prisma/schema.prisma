generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Account {
  id                 String   @id
  userId             String
  provider           String
  providerAccountId  String
  type               String
  access_token       String?
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String?
  refresh_token      String?
  session_state      String?
  oauth_token_secret String?
  oauth_token        String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime
  User               User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@unique([userId, provider])
  @@index([userId])
}

model AuditLog {
  id          Int          @id @default(autoincrement())
  userId      String?
  workspaceId Int?
  projectId   Int?
  action      AuditActions
  entityType  String
  entityId    String?
  details     String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime
  Project     Project?     @relation(fields: [projectId], references: [id])
  User        User?        @relation(fields: [userId], references: [id])
  Workspace   Workspace?   @relation(fields: [workspaceId], references: [id])

  @@index([action])
  @@index([entityType, entityId, createdAt])
  @@index([entityType, entityId])
  @@index([projectId, createdAt])
  @@index([userId])
  @@index([workspaceId, createdAt])
}

model Invitation {
  id                                  Int              @id @default(autoincrement())
  invitedUserEmail                    String
  invitedRole                         Role             @default(MEMBER)
  inviterId                           String?
  invitedUserId                       String?
  workspaceId                         Int
  status                              InvitationStatus @default(PENDING)
  token                               String           @unique
  expiresAt                           DateTime
  acceptedAt                          DateTime?
  createdAt                           DateTime         @default(now())
  updatedAt                           DateTime
  User_Invitation_invitedUserIdToUser User?            @relation("Invitation_invitedUserIdToUser", fields: [invitedUserId], references: [id])
  User_Invitation_inviterIdToUser     User?            @relation("Invitation_inviterIdToUser", fields: [inviterId], references: [id])
  Workspace                           Workspace        @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([expiresAt])
  @@index([invitedUserEmail])
  @@index([workspaceId, status])
}

model Membership {
  id          Int              @id @default(autoincrement())
  role        Role             @default(MEMBER)
  userId      String
  workspaceId Int
  status      MembershipStatus @default(ACTIVE)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime
  User        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  Workspace   Workspace        @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([userId, workspaceId])
  @@index([userId])
  @@index([workspaceId])
}

model Notification {
  id          Int              @id @default(autoincrement())
  userId      String
  type        NotificationType
  title       String
  message     String
  workspaceId Int?
  isRead      Boolean          @default(false)
  metadata    Json?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime
  isHidden    Boolean          @default(false)
  User        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  Workspace   Workspace?       @relation(fields: [workspaceId], references: [id])

  @@index([userId, isRead, createdAt])
}

model Payment {
  id              String        @id
  userId          String
  tariff          Tariff
  amount          Decimal       @db.Decimal(12, 2)
  currency        String        @default("KZT")
  cloudpaymentsId String?
  invoiceId       String?
  status          PaymentStatus
  reason          String?
  paidAt          DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime
  isSubscription  Boolean       @default(false)
  subscriptionId  String?
  validUntil      DateTime?
  User            User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([cloudpaymentsId])
  @@index([paidAt])
  @@index([status])
  @@index([userId])
  @@index([userId, paidAt])
}

model Project {
  id          Int        @id @default(autoincrement())
  name        String
  description String?
  workspaceId Int
  createdAt   DateTime   @default(now())
  updatedAt   DateTime
  endedAt     DateTime?
  AuditLog    AuditLog[]
  Workspace   Workspace  @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  Sprint      Sprint[]
  Task        Task[]

  @@unique([workspaceId, name])
  @@index([workspaceId])
}

model Session {
  id           String   @id
  sessionToken String   @unique
  userId       String
  expires      DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime
  User         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Sprint {
  id        Int          @id @default(autoincrement())
  name      String
  goal      String?
  projectId Int
  startDate DateTime?
  endDate   DateTime?
  status    SprintStatus @default(PLANNED)
  createdAt DateTime     @default(now())
  updatedAt DateTime
  color     SprintColor  @default(POWDER)
  Project   Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  Task      Task[]

  @@index([projectId])
}

model Task {
  id          Int          @id @default(autoincrement())
  title       String
  description String?
  status      TaskStatus   @default(TODO)
  dueDate     DateTime?
  projectId   Int
  assigneeId  String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime
  priority    TaskPriority @default(LOW)
  sprintId    Int?
  completedAt DateTime?
  User        User?        @relation(fields: [assigneeId], references: [id])
  Project     Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  Sprint      Sprint?      @relation(fields: [sprintId], references: [id])

  @@index([assigneeId])
  @@index([dueDate])
  @@index([projectId])
  @@index([projectId, priority])
  @@index([projectId, sprintId, status])
  @@index([projectId, status, createdAt])
  @@index([sprintId])
  @@index([status])
}

model User {
  id                                        String         @id @default(cuid())
  email                                     String         @unique
  lastName                                  String?
  firstName                                 String?
  image                                     String?
  emailVerified                             DateTime?
  password                                  String?
  createdAt                                 DateTime       @default(now())
  updatedAt                                 DateTime
  wasOnline                                 DateTime?
  nickname                                  String?
  currentTariff                             Tariff         @default(FREE)
  platformRole                              PlatformRole   @default(USER)
  Account                                   Account[]
  AuditLog                                  AuditLog[]
  Invitation_Invitation_invitedUserIdToUser Invitation[]   @relation("Invitation_invitedUserIdToUser")
  Invitation_Invitation_inviterIdToUser     Invitation[]   @relation("Invitation_inviterIdToUser")
  Membership                                Membership[]
  Notification                              Notification[]
  Payment                                   Payment[]
  Session                                   Session[]
  Task                                      Task[]
  Workspace                                 Workspace[]
}

model VerificationToken {
  id         String   @id
  identifier String
  token      String   @unique
  expires    DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime

  @@unique([identifier, token])
}

model Workspace {
  id           Int            @id @default(autoincrement())
  name         String
  createdAt    DateTime       @default(now())
  updatedAt    DateTime
  description  String?
  ownerId      String?
  avatarUrl    String?        @db.VarChar(512)
  AuditLog     AuditLog[]
  Invitation   Invitation[]
  Membership   Membership[]
  Notification Notification[]
  Project      Project[]
  User         User?          @relation(fields: [ownerId], references: [id])
}

enum AuditActions {
  CREATE
  UPDATE
  DELETE
  INVITE_SENT
  INVITE_ACCEPTED
  TASK_STATUS_CHANGED
  TASK_ASSIGNEE_CHANGED
  PROJECT_RENAMED
  LOGIN
  LOGOUT
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  REVOKED
  EXPIRED
}

enum MembershipStatus {
  PENDING
  ACTIVE
  REMOVED
}

enum NotificationType {
  WORKSPACE_DELETED
  WORKSPACE_INVITE
  TASK_ASSIGNED
  TASK_STATUS_CHANGED
  PAYMENT_COMPLETED
  WORKSPACE_NOTIFICATION
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
  REFUNDED
}

enum PlatformRole {
  USER
  SYSADMIN
}

enum Role {
  MEMBER
  OWNER
  ADMIN
}

enum SprintColor {
  LAVENDER
  MINT
  PEACH
  BABY_BLUE
  BLUSH
  LILAC
  APRICOT
  POWDER
  SKY
}

enum SprintStatus {
  PLANNED
  ACTIVE
  COMPLETED
  CANCELLED
}

enum Tariff {
  FREE
  PRO
  BUSINESS
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  DONE
  BLOCKED
}

enum TaskType {
  TASK
  BUG
  STORY
  EPIC
}
